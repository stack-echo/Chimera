version: '3.8'

services:
  # 1. 业务数据库 (元数据)
  mysql:
    image: mysql:8.0
    container_name: rag_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: rag_db
    ports:
      - "3306:3306"
    volumes:
      - ../local_data/mysql:/var/lib/mysql
    networks:
      - rag_net

  # 2. 缓存与消息队列
  redis:
    image: redis:alpine
    container_name: rag_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    networks:
      - rag_net

  # 3. 对象存储 (存图片/PDF)
  minio:
    image: minio/minio
    container_name: rag_minio
    ports:
      - "9000:9000"   # API 端口
      - "9001:9001"   # 控制台端口
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - ../local_data/minio:/data
    networks:
      - rag_net

  # 4. 向量数据库
  # 注意：Milvus 生产环境需要 etcd 和 minio，这里使用 standalone 模式简化
  milvus-standalone:
    image: milvusdb/milvus:v2.3.0
    container_name: rag_milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - ../local_data/milvus:/var/lib/milvus
    ports:
      - "19530:19530"
    depends_on:
      - "etcd"
      - "minio"
    networks:
      - rag_net

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
    networks:
      - rag_net

  # 5. 图数据库 (NebulaGraph Lite)
  # Nebula 通常需要 graphd, metad, storaged 三个容器
  # 这里为了演示方便，我们使用官方的 Docker Compose 快速部署脚本核心部分
  # 如果电脑配置低，这一步可以先注释掉，后续再加
  nebula-graphd:
    image: vesoft/nebula-graphd:v3.6.0
    container_name: rag_nebula_graphd
    ports:
      - "9669:9669" # 客户端连接端口
    networks:
      - rag_net
    command: --meta_server_addrs=nebula-metad:9559 --local_ip=nebula-graphd

  nebula-metad:
    image: vesoft/nebula-metad:v3.6.0
    container_name: rag_nebula_metad
    networks:
      - rag_net
    command: --local_ip=nebula-metad

  nebula-storaged:
    image: vesoft/nebula-storaged:v3.6.0
    container_name: rag_nebula_storaged
    networks:
      - rag_net
    command: --meta_server_addrs=nebula-metad:9559 --local_ip=nebula-storaged

networks:
  rag_net:
    driver: bridge